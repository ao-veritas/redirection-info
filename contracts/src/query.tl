local dbHelpers = require("db")
local parseData = require("parse")
local json = require("json")

local TEST_RESPONSE =
[[{"data":{"transactions":{"pageInfo":{"hasNextPage":false},"edges":[{"cursor":"eyJzZWFyY2hfYWZ0ZXIiOls5MjIzMzcyMDM2ODU0Nzc2MDAwLCIwQWtBRkNORng4VEljNnliYmRVck5waWZEV1FhTWJTR0wzMGp5TjQ4elI4Il0sImluZGV4Ijo5NX0=","node":{"id":"0AkAFCNFx8TIc6ybbdUrNpifDWQaMbSGL30jyN48zR8","block":null,"recipient":"BaMK1dfayo75s3q1ow6AO64UDpD9SEFbeE8xYrY2fyQ","owner":{"address":"fcoN_xJeisVsPXA-trzVAuIiqO3ydLQxM-L4XbrQKzY"},"tags":[{"name":"Ref_","value":"2152229"},{"name":"X-Action","value":"Post-Real-Data"},{"name":"Quantity","value":"1000000000000"},{"name":"Action","value":"Credit-Notice"},{"name":"Sender","value":"CB0wY0UgCwnD4t8o_x7pbiICrVk01gCtvUe6mXDFJeA"},{"name":"X-Url","value":"https://ai-blog-ad8c.onrender.com/generate"},{"name":"X-Body","value":"{\"pid\":\"tDQAAYlQ7W0GvPwGac7YUsBv3iIQzNZlye74QIq8j2c\",\"topic\":\"Submarine\"}"},{"name":"Data-Protocol","value":"ao"},{"name":"Type","value":"Message"},{"name":"Variant","value":"ao.TN.1"},{"name":"From-Process","value":"BUhZLMwQ6yZHguLtJYA5lLUa9LQzLXMXRfaq9FVcPJc"},{"name":"From-Module","value":"9afQ1PLf2mrshqCTZEzzJTR2gWaC9zNPnYgYEqg1Pt4"},{"name":"Pushed-For","value":"qIbfr5qDqIe6INGuR4t2UKfRppg8PUvpoSIX65g5Tqk"}]}},{"cursor":"eyJzZWFyY2hfYWZ0ZXIiOls5MjIzMzcyMDM2ODU0Nzc2MDAwLCJVM25JejhMMEtMR0Y2am1NSTVPcC1lc0Q2NzlCUHp4cnVMaFR2N3B1emhvIl0sImluZGV4Ijo5Nn0=","node":{"id":"U3nIz8L0KLGF6jmMI5Op-esD679BPzxruLhTv7puzho","block":null,"recipient":"BaMK1dfayo75s3q1ow6AO64UDpD9SEFbeE8xYrY2fyQ","owner":{"address":"fcoN_xJeisVsPXA-trzVAuIiqO3ydLQxM-L4XbrQKzY"},"tags":[{"name":"Ref_","value":"2422820"},{"name":"X-Action","value":"Post-Real-Data"},{"name":"Quantity","value":"1000000000000"},{"name":"Action","value":"Credit-Notice"},{"name":"Sender","value":"CB0wY0UgCwnD4t8o_x7pbiICrVk01gCtvUe6mXDFJeA"},{"name":"X-Url","value":"https://ai-blog-ad8c.onrender.com/generate"},{"name":"X-Body","value":"{\"pid\":\"AyhPMzYk5AyQ7h4yz1dodcAZU_6NGxix4En-19lddYQ\",\"topic\":\"food\"}"},{"name":"Data-Protocol","value":"ao"},{"name":"Type","value":"Message"},{"name":"Variant","value":"ao.TN.1"},{"name":"From-Process","value":"BUhZLMwQ6yZHguLtJYA5lLUa9LQzLXMXRfaq9FVcPJc"},{"name":"From-Module","value":"9afQ1PLf2mrshqCTZEzzJTR2gWaC9zNPnYgYEqg1Pt4"},{"name":"Pushed-For","value":"X67Kf5jG3MCpTP7nra1lz4moLpSougBJDp7EP9Xbq8g"}]}},{"cursor":"eyJzZWFyY2hfYWZ0ZXIiOls5MjIzMzcyMDM2ODU0Nzc2MDAwLCJXekFHWHh1aEFxaHJuUUNQemVEX3VuaVJtZW5Eckx0dGx3V1RQcnpXUWVBIl0sImluZGV4Ijo5N30=","node":{"id":"WzAGXxuhAqhrnQCPzeD_uniRmenDrLttlwWTPrzWQeA","block":null,"recipient":"BaMK1dfayo75s3q1ow6AO64UDpD9SEFbeE8xYrY2fyQ","owner":{"address":"fcoN_xJeisVsPXA-trzVAuIiqO3ydLQxM-L4XbrQKzY"},"tags":[{"name":"Ref_","value":"4270305"},{"name":"X-Url","value":"https://g8way.0rbit.co/graphql"},{"name":"Quantity","value":"1000000000000"},{"name":"Action","value":"Credit-Notice"},{"name":"Sender","value":"-Nt_Xq7q9QoLzDMEfi3yNN05VXz4zpTyMfCp24ur9Zc"},{"name":"X-Body","value":"{\"query\":\"                            query {\\n                                transactions(\\n                                    owners: [\\\"vh-NTHVvlKZqRxc8LyyTNok65yQ55a_PJ1zWLb9G2JI\\\"]\\n                                ) {\\n                                    edges {\\n                                        node {\\n                                            id\\n                                        }\\n                                    }\\n                                }\\n                            }\\n                        \"}"},{"name":"X-Action","value":"Post-Real-Data"},{"name":"Data-Protocol","value":"ao"},{"name":"Type","value":"Message"},{"name":"Variant","value":"ao.TN.1"},{"name":"From-Process","value":"BUhZLMwQ6yZHguLtJYA5lLUa9LQzLXMXRfaq9FVcPJc"},{"name":"From-Module","value":"9afQ1PLf2mrshqCTZEzzJTR2gWaC9zNPnYgYEqg1Pt4"},{"name":"Pushed-For","value":"esF-usNbr-NEOW3uheqcB5XaIC3rXIyfzdGek3dUPv0"}]}},{"cursor":"eyJzZWFyY2hfYWZ0ZXIiOls5MjIzMzcyMDM2ODU0Nzc2MDAwLCJnZk1VQng1b29VeHJoa1JoTVEyUnlmZEI2SnFLM00ta3NvRHU1Q0FacFJjIl0sImluZGV4Ijo5OH0=","node":{"id":"gfMUBx5ooUxrhkRhMQ2RyfdB6JqK3M-ksoDu5CAZpRc","block":null,"recipient":"BaMK1dfayo75s3q1ow6AO64UDpD9SEFbeE8xYrY2fyQ","owner":{"address":"fcoN_xJeisVsPXA-trzVAuIiqO3ydLQxM-L4XbrQKzY"},"tags":[{"name":"Ref_","value":"8455127"},{"name":"X-Url","value":"https://arweave-search.goldsky.com/graphql"},{"name":"Quantity","value":"1000000000000"},{"name":"Action","value":"Credit-Notice"},{"name":"Sender","value":"_y0cUKnoQevsE6fOGkdQPk0dM64Ps2KS3uPzm6S17e0"},{"name":"X-Body","value":"{\"query\":\"        query {\\n            transactions(\\n                block: {\\n            min: 1455662        }                sort: HEIGHT_ASC\\n\\n                recipients:[\\\"BaMK1dfayo75s3q1ow6AO64UDpD9SEFbeE8xYrY2fyQ\\\"]\\n                first: 200\\n                tags: [{name:\\\"X-Action\\\",values:[\\\"Post-Real-Data\\\"]}]            )\\n            {\\n                pageInfo {\\n                    hasNextPage\\n                }\\n                edges {\\n                    cursor\\n                    node {\\n                        id\\n                        block {\\n                            height\\n                            timestamp\\n                        }\\n                        recipient\\n                        owner {\\n                            address\\n                        }\\n                        tags {\\n                            name\\n                            value\\n                        }\\n                    }\\n                }\\n            }\\n        }\\n        \"}"},{"name":"X-Action","value":"Post-Real-Data"},{"name":"Data-Protocol","value":"ao"},{"name":"Type","value":"Message"},{"name":"Variant","value":"ao.TN.1"},{"name":"From-Process","value":"BUhZLMwQ6yZHguLtJYA5lLUa9LQzLXMXRfaq9FVcPJc"},{"name":"From-Module","value":"9afQ1PLf2mrshqCTZEzzJTR2gWaC9zNPnYgYEqg1Pt4"},{"name":"Pushed-For","value":"FupyTEXWgATM4jl0TSSDRxplTOimNeVfmpgP-eOV7uc"}]}}]}}}]]
Handlers.add(
    "Test-Response",
    Handlers.utils.hasMatchingTag("Action", "Test-Response"),
    function()
        -- local nextCursor = parseResponse(json.decode(TEST_RESPONSE))
        -- print('nextCursor is:', nextCursor)
        local data = dbHelpers.getTableData('')
        print("got " .. #data .. " records")

        -- print(data[1])

        -- local messageActivityData = parseData.getMessageActivityData(data, "X-Action",
        --     { "Post-Real-Data", "Get-Real-Data" })
        -- print(json.encode(messageActivityData.totalMessageDistribution))

        -- local userActivityData = parseData.getUserActivityData(data, "Sender", "tags", "X-Action",
        --     { "Post-Real-Data", "Get-Real-Data" })

        -- print(json.encode(userActivityData.uniqueUsers))

        print('TEST_RESPONSE parsed successfully')
    end
)